<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="app_layout :: head('Вишлист')"></head>

<body th:replace="app_layout :: page(~{::main}, 'Вишлист', 'wishlists')">
<main>
  <div class="rounded-3xl bg-white/5 border border-white/10 p-4 overflow-hidden">
    <div class="text-2xl font-semibold" th:text="${wishlist.title}">Вишлист</div>
    <div class="text-white/60 mt-1" th:text="${wishlist.description} ?: ''"></div>

    <div class="mt-4 flex gap-2 flex-wrap">
      <a href="/wishlists" class="px-4 py-2 rounded-2xl bg-white/10 border border-white/10 hover:bg-white/15">Назад</a>
    </div>
  </div>

  <!-- Добавлять подарки можно в уже созданный вишлист (только владелец) -->
  <div class="mt-4 rounded-3xl bg-white/5 border border-white/10 p-4 overflow-hidden" th:if="${isOwner}">
    <div class="text-lg font-semibold">Добавить желание</div>

    <form class="mt-4 space-y-3"
          th:action="@{/wishlists/{id}/wishes(id=${wishlist.id})}"
          method="post" enctype="multipart/form-data">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

      <input name="title" required maxlength="200"
             class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
             placeholder="Название"/>

      <input name="link" type="url"
             class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
             placeholder="Ссылка (необязательно)"/>

      <input name="price"
             class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
             placeholder="Цена (необязательно)"/>

      <textarea name="note" rows="3"
                class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
                placeholder="Комментарий (необязательно)"></textarea>

      <div>
        <label class="block text-sm text-white/70 mb-2">Фото (из галереи/файлов)</label>
        <input name="image" type="file" accept="image/*"
               class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"/>
      </div>

      <button type="submit"
              class="w-full rounded-2xl bg-white text-black font-semibold py-3 hover:bg-white/90">
        Добавить
      </button>
    </form>
  </div>

  <div class="mt-4 rounded-3xl bg-white/5 border border-white/10 p-4 overflow-hidden">
    <div class="text-lg font-semibold">Желания</div>

    <div class="mt-3 space-y-3">
      <div th:if="${items == null or #lists.isEmpty(items)}" class="text-white/60">
        Пока пусто.
      </div>

      <div th:each="v : ${itemViews}" class="rounded-2xl bg-white/5 border border-white/10 p-4 overflow-hidden">
        <div class="flex items-start justify-between gap-3">
          <div class="text-lg font-semibold" th:text="${v.item.title}">Название</div>
          <div class="text-white/60" th:text="${v.item.price != null and !#strings.isEmpty(v.item.price) ? (v.item.price + ' ₽') : ''}"></div>
        </div>

        <div class="mt-2" th:if="${v.item.link != null and !#strings.isEmpty(v.item.link)}">
          <a class="text-white underline underline-offset-4 break-all"
             th:href="${v.item.link}" target="_blank" rel="noopener"
             th:text="${v.item.link}">link</a>
        </div>

        <div class="mt-2 text-white/70" th:if="${v.item.note != null and !#strings.isEmpty(v.item.note)}"
             th:text="${v.item.note}">note</div>

        <!-- Фото -->
        <div class="mt-3" th:if="${v.item.imagePath != null and !#strings.isEmpty(v.item.imagePath)}">
          <img th:src="${v.item.imagePath}" alt="Фото" class="w-full rounded-2xl border border-white/10 object-cover max-h-80"/>
        </div>

        <!-- Копилка -->
        <div class="mt-3 rounded-2xl bg-black/20 border border-white/10 p-3">
          <div class="text-sm text-white/70">Копилка</div>

          <div class="mt-2 text-white/80" th:if="${v.fundEnabled}">
            <span th:text="${v.collectedAmount}">0</span> ₽ собрано
            <span class="text-white/60" th:text="|из ${v.targetRub} ₽|">из 0 ₽</span>
          </div>
          <div class="mt-2 text-white/60" th:if="${!v.fundEnabled}">
            Копилка пока не включена.
          </div>

          <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden" th:if="${v.fundEnabled}">
            <div class="h-full bg-white transition-all"
                 th:style="'width: ' + ${v.collectedPercent} + '%'">
            </div>
          </div>

          <div class="mt-1 text-xs text-white/40" th:if="${v.fundEnabled}"
               th:text="|${v.collectedPercent}%|">
            0%
          </div>

          <div class="mt-3" th:if="${isOwner}">
            <form th:action="@{/wishes/{wishId}/fund/enable(wishId=${v.item.id})}"
                  method="post"
                  class="flex flex-col sm:flex-row gap-2 items-start">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input name="targetRub" type="number" min="1" required
                     th:value="${v.targetRub > 0 ? v.targetRub : ''}"
                     class="w-full sm:w-48 rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
                     placeholder="Цель, ₽"/>
              <button type="submit"
                      class="px-4 py-3 rounded-2xl bg-white text-black font-semibold hover:bg-white/90">
                <span th:text="${v.fundEnabled ? 'Обновить копилку' : 'Включить копилку'}">Включить копилку</span>
              </button>
            </form>
          </div>

          <div class="mt-3" th:if="${!isOwner and v.fundEnabled}">
            <form th:action="@{/wishes/{wishId}/fund/contribute(wishId=${v.item.id})}"
                  method="post"
                  class="grid md:grid-cols-[1fr,1fr,auto] gap-2">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <input name="amountRub" type="number" min="1" required
                     class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
                     placeholder="Сумма, ₽"/>
              <input name="message" maxlength="500"
                     class="w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 outline-none focus:border-white/30"
                     placeholder="Комментарий (необязательно)"/>
              <button type="submit"
                      class="w-full md:w-auto px-4 py-3 rounded-2xl bg-white text-black font-semibold hover:bg-white/90">
                Скинуться
              </button>
            </form>
          </div>
        </div>

        <!-- Бронь с приватностью -->
        <div class="mt-3 rounded-2xl bg-black/20 border border-white/10 p-3">
          <div class="text-sm text-white/70">Бронь</div>

          <!-- Владелец НЕ видит кто -->
          <div th:if="${isOwner}">
            <div class="mt-1 text-white/60" th:if="${v.item.reservedBy == null}">Свободно</div>
            <div class="mt-1 text-white/90" th:if="${v.item.reservedBy != null}">Забронировано</div>
          </div>

          <!-- Не владелец -->
          <div th:if="${!isOwner}">
            <div class="mt-1 text-white/60" th:if="${v.item.reservedBy == null}">
              Свободно — можешь забронировать.
            </div>

            <div class="mt-1 text-white/90" th:if="${v.item.reservedBy != null and v.item.reservedBy.id != meId}">
              Уже забронировано
            </div>

            <div class="mt-1 text-white/90" th:if="${v.item.reservedBy != null and v.item.reservedBy.id == meId}">
              Забронировано тобой
            </div>

            <div class="mt-3 flex gap-2 flex-wrap">
              <form th:if="${v.item.reservedBy == null}"
                    th:action="@{/wishlists/{wid}/wishes/{id}/reserve(wid=${wishlist.id}, id=${v.item.id})}"
                    method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="px-4 py-2 rounded-2xl bg-white text-black font-semibold hover:bg-white/90">
                  Забронировать
                </button>
              </form>

              <form th:if="${v.item.reservedBy != null and v.item.reservedBy.id == meId}"
                    th:action="@{/wishlists/{wid}/wishes/{id}/unreserve(wid=${wishlist.id}, id=${v.item.id})}"
                    method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="px-4 py-2 rounded-2xl bg-white/10 border border-white/10 hover:bg-white/15">
                  Снять бронь
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Удаление подарка (только владелец) -->
        <div class="mt-3" th:if="${isOwner}">
          <form th:action="@{/wishlists/{wid}/wishes/{id}/delete(wid=${wishlist.id}, id=${v.item.id})}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="w-full px-4 py-2 rounded-2xl bg-white/10 border border-white/10 hover:bg-white/15 text-left">
              Удалить подарок
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>
</main>
</body>
</html>
